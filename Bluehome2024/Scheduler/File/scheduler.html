<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Refresh Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            height: 100%;
        }

        h1 {
            color: #333;
        }

        p {
            color: #666;
        }

        .loader {
            display: none;
            /* initially hidden */
            border: 8px solid #f3f3f3;
            /* Light grey */
            border-top: 8px solid #3498db;
            /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite, fadeOut 2s forwards;
            margin: 20px auto;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .notification {
            display: none;
            background-color: #4CAF50;
            color: white;
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        #cronData {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        /* CSS untuk toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 999;
            display: none;
        }

        /* CSS untuk count */
        #failedLoadCount {
            color: red;
            font-weight: bold;
        }

        /* CSS untuk tabel */
        .scrollable-container {
            max-height: 300px;
            overflow-y: auto;
            position: relative;
            /* tambahkan posisi relatif untuk kontainer */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th,
        td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        /* CSS untuk membuat thead tetap */
        thead {
            position: sticky;
            top: 0;
            background-color: #f2f2f2;
        }

        /* CSS untuk membuat sel-sel thead tetap tidak transparan */
        thead th {
            z-index: 1;
            position: sticky;
            top: 0;
            background-color: #f2f2f2;
        }
    </style>
    <script>
        // Mendapatkan nilai failedLoadCount dari localStorage saat halaman dimuat
        var failedLoadCount = localStorage.getItem('failedLoadCount') ? parseInt(localStorage.getItem('failedLoadCount')) : 0;

        // Fungsi untuk menampilkan loader
        function showLoader() {
            var loader = document.querySelector('.loader');
            loader.style.display = 'block';
        }

        // Fungsi untuk menampilkan notifikasi
        function showNotification(message) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';

            setTimeout(function () {
                toast.style.display = 'none';
            }, 3000); // Hapus notifikasi setelah 3 detik
        }

        // Fungsi untuk memperbarui halaman cron setiap 5 detik
        function autoRefreshCron() {
            showLoader(); // Menampilkan loader
            setTimeout(function () {
                loadCronData(); // Memuat ulang data cron
                updateCountTable();
                autoRefreshCron(); // Memanggil kembali fungsi ini untuk memperbarui secara terus-menerus
            }, 5000);
        }

        // Fungsi untuk memuat konten dari cron.php
        function loadCronData() {
            fetch('https://bluehomeid.my.id/system/cron.php')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('cronData').innerHTML = data;
                    console.log('cron.php loaded successfully.');
                    showNotification('Konten berhasil dimuat!');
                    hideLoader(); // Menyembunyikan loader setelah memuat berhasil
                })
                .catch(error => {
                    console.error('Error loading cron.php:', error);
                    var currentTime = new Date().toLocaleString();
                    localStorage.setItem('failureTime' + failedLoadCount, currentTime);
                    failedLoadCount++;
                    localStorage.setItem('failedLoadCount', failedLoadCount);
                    showNotification('Gagal memuat konten: ' + error.message);
                    hideLoader(); // Menyembunyikan loader setelah memuat gagal
                });
        }

        // Fungsi untuk menyembunyikan loader
        function hideLoader() {
            var loader = document.querySelector('.loader');
            loader.style.display = 'none';
        }

        // Fungsi untuk mereset nilai count ke 0 setiap hari pukul 9 malam
        function resetCountDaily() {
            var now = new Date();
            if (now.getHours() === 21 && now.getMinutes() === 0 && now.getSeconds() === 0) {
                failedLoadCount = 0;
                localStorage.setItem('failedLoadCount', failedLoadCount);
            }
        }



        // Fungsi untuk memperbarui tabel dengan 10 data terakhir
        function updateCountTable() {
            var countTable = document.getElementById('countTable');
            countTable.innerHTML = ''; // Kosongkan tabel sebelum memasukkan data baru
            var counts = [];
            for (var i = failedLoadCount; i >= 1; i--) { // Iterasi dari nomor terbaru ke nomor 1
                counts.push({
                    count: i,
                    time: localStorage.getItem('failureTime' + i) || '-'
                });
            }

            counts.forEach(function (item) {
                var row = countTable.insertRow();
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                cell1.textContent = item.count;
                cell2.textContent = item.time;
            });
            if (failedLoadCount > 10) {
                countTable.parentElement.style.overflowY = 'scroll';
                countTable.parentElement.style.maxHeight = '300px';
            } else {
                countTable.parentElement.style.overflowY = 'auto';
                countTable.parentElement.style.maxHeight = 'none';
            }
        }

        // Fungsi untuk memeriksa apakah storage dihapus
        function checkLocalStorage() {
            if (!localStorage.getItem('failedLoadCount')) {
                failedLoadCount = 0;
                localStorage.setItem('failedLoadCount', failedLoadCount);
            }
        }

        // Panggil fungsi checkLocalStorage saat halaman dimuat
        window.onload = function () {
            checkLocalStorage();
            autoRefreshCron(); // Panggil fungsi untuk memulai pembaruan otomatis
            loadCronData(); // Memuat data cron saat halaman dimuat
            updateCountTable(); // Panggil fungsi untuk memperbarui tabel dengan data terakhir
            // Panggil fungsi resetCountDaily setiap detik untuk memeriksa apakah harus mereset nilai count
            setInterval(resetCountDaily, 1000);
        };

        // Event listener untuk memeriksa perubahan storage
        window.addEventListener('storage', function (e) {
            if (!localStorage.getItem('failedLoadCount')) {
                failedLoadCount = 0;
                localStorage.setItem('failedLoadCount', failedLoadCount);
            }
        });

    </script>
</head>

<body>
    <h1>Auto Refresh Example</h1>
    <div class="loader"></div>
    <p>This page will refresh every 5 seconds.</p>

    <!-- Tambahkan elemen toast di sini -->
    <div class="toast" id="toast"></div>

    <!-- Tambahkan elemen untuk menampilkan count sebagai tabel -->
    <div class="scrollable-container">
        <table>
            <thead>
                <tr>
                    <th>Gagal memuat konten</th>
                    <th>Terakhir gagal pada</th>
                </tr>
            </thead>
            <tbody id="countTable">
                <!-- Data count akan dimasukkan di sini -->
            </tbody>
        </table>
    </div>
    <div id="cronData"></div>
</body>

</html>